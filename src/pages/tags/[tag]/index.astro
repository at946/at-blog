---
export const prerender = true;

import { getCollection } from 'astro:content';
import PostPreviewList from '@components/PostPreviewList.astro';
import DefaultPageLayout from '@layouts/default.astro';

export async function getStaticPaths() {
	const allPosts = await getCollection(
		'blog',
		({ data }) =>
			data.isPublished &&
			new Date(data.publicationDate) <= new Date() &&
			!!data.tags,
	);
	const allTags = new Set();
	allPosts.map((post) => {
		post.data.tags?.map((tag) => allTags.add(tag));
	});

	return Array.from(allTags).map((tag) => {
		const filteredPosts = allPosts.filter((post) =>
			post.data.tags.includes(tag),
		);
		const res = { params: { tag }, props: { pages: filteredPosts } };
		if (filteredPosts.length > 1) {
			res.props.pages = filteredPosts.sort(
				(a, b) =>
					new Date(b.data.publicationDate) - new Date(a.data.publicationDate),
			);
		}

		return res;
	});
}

const { pages } = Astro.props;
const { tag } = Astro.params;
---

<DefaultPageLayout content={{ title: `Tag: ${tag}`, description: `all of the articles we have posted and linked so far under the tag: ${tag}` }}>
    <PostPreviewList posts={pages} />
</DefaultPageLayout>
